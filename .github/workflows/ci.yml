name: Project CI with QuantumLeap

on:
  pull_request:
    branches: [ main ]

# Github Actions Commentë¥¼ ìœ„í•œ ê¶Œí•œ ì„¤ì • ì¶”ê°€(2025-11-05)
permissions:
  pull-requests: write

jobs:
  optimized-test:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Checkout Target Project Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Git ë³€ê²½ì  ë¶„ì„ ìœ„í•œ ì „ì²´ íˆìŠ¤í† ë¦¬ ë¡œë“œ

      # ê°œë°œ í™˜ê²½ ì„¤ì •
      - name: 2. Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      # ë¶„ì„ê¸° jar íŒŒì¼ ë‹¤ìš´ë¡œë“œ
      - name: 3. Download QuantumLeap Analyzer
        run: |
          wget https://github.com/JungHyeonwoo/PBL/releases/download/v1.0.1/QuantumLeap-1.0.jar -O quantumleap.jar

      # ë¶„ì„ê¸° ì‹¤í–‰ ë° ê²°ê³¼ ìº¡ì²˜
      - name: 4. Run QuantumLeap Analyzer
        id: analyze
        run: |
          STDOUT_FILE=$(mktemp)
          STDERR_FILE=$(mktemp)
          
          java -jar quantumleap.jar . \
            --base ${{ github.event.before }} \
            --head ${{ github.event.after }} \
            --projectRoot 
            > "$STDOUT_FILE" 2> >(tee "$STDERR_FILE" >&2) || true
          
          TESTS_TO_RUN=$(cat "$STDOUT_FILE")
          ANALYSIS_LOG_CLEAN=$(cat "$STDERR_FILE")
          
          rm "$STDOUT_FILE" "$STDERR_FILE"

          TESTS_TO_RUN=$(echo "${ANALYSIS_LOG}" | grep -v "ğŸš€" | grep -v "â„¹ï¸" | grep -v "âœ…" | grep -v "âš ï¸" | grep -v "===" | grep -v "ë¶„ì„")
          ANALYSIS_LOG_CLEAN=$(echo "${ANALYSIS_LOG}" | grep -E "ğŸš€|â„¹ï¸|âœ…|âš ï¸|===|ë¶„ì„")

          # ì—¬ëŸ¬ ì¤„ì˜ í…ŒìŠ¤íŠ¸ ëª©ë¡ì„ Gradle --tests ì˜µì…˜ í˜•ì‹ì˜ í•œ ì¤„ ë¬¸ìì—´ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
          TESTS_STRING=$(echo "$TESTS_TO_RUN" | awk '{printf "--tests \\"%s\\" ", $0}' | sed 's/ $//')

          echo "tests_string=$TESTS_STRING" >> "$GITHUB_OUTPUT"
          echo "tests_list_md<<EOF" >> "$GITHUB_OUTPUT"
          echo "$TESTS_TO_RUN" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"
          echo "analysis_log_md<<EOF" >> "$GITHUB_OUTPUT"
          echo "$ANALYSIS_LOG_CLEAN" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      # í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      - name: 5. Run Selected Tests
        id: test # ì´ ë‹¨ê³„ì— IDë¥¼ ë¶€ì—¬í•˜ì—¬ ê²°ê³¼ë¥¼ ì¶”ì í•©ë‹ˆë‹¤.
        if: steps.analyze.outputs.tests_string != ''
        run: |
          echo "ì„ ë³„ëœ í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤: ${{ steps.analyze.outputs.tests_string }}"
          chmod +x ./gradlew
          ./gradlew test ${{ steps.analyze.outputs.tests_string }}

      - name: 6. Run All Tests (Fallback)
        id: test-all # ì´ ë‹¨ê³„ì—ë„ IDë¥¼ ë¶€ì—¬í•©ë‹ˆë‹¤.
        if: steps.analyze.outputs.tests_string == ''
        run: |
          echo "ì„ ë³„ëœ í…ŒìŠ¤íŠ¸ê°€ ì—†ì–´ ì „ì²´ í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤."
          chmod +x ./gradlew
          ./gradlew test

      # ë¹Œë“œ ë¦¬í¬íŠ¸ ìƒì„± ë° PR ì½”ë©˜íŠ¸ ê²Œì‹œ
      - name: 7. Post Build Report Comment
        if: always() # ë¹Œë“œ ì„±ê³µ/ì‹¤íŒ¨ ì—¬ë¶€ì— ê´€ê³„ì—†ì´ í•­ìƒ ì‹¤í–‰
        uses: peter-evans/create-or-update-comment@v4
        with:
          # PRì— ì½”ë©˜íŠ¸ë¥¼ ë‹¬ê¸° ìœ„í•œ GitHub í† í°
          token: ${{ secrets.GITHUB_TOKEN }}
          # ì½”ë©˜íŠ¸ë¥¼ ë‹¬ ì´ìŠˆ(PR) ë²ˆí˜¸
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ### ğŸš€CI ë¶„ì„ ë¦¬í¬íŠ¸

            **${{ github.event.pull_request.head.ref }}** ë¸Œëœì¹˜ì˜ ë¹Œë“œë¥¼ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤.

            ---

            #### ğŸ“Š ë¹Œë“œ ìš”ì•½
            | í•­ëª© | ê²°ê³¼ |
            | :--- | :--- |
            | **ë¹Œë“œ ìƒíƒœ** | ${{ job.status == 'success' && 'âœ… ì„±ê³µ' || 'âŒ ì‹¤íŒ¨' }} |
            | **ì„ ë³„ëœ í…ŒìŠ¤íŠ¸** | `${{ steps.analyze.outputs.tests_string == '' && 'ì „ì²´ í…ŒìŠ¤íŠ¸ ì‹¤í–‰' || 'ì„ ë³„ëœ í…ŒìŠ¤íŠ¸ ì‹¤í–‰' }}` |

            ---

            #### ì•„í‚¤í…ì²˜ ê±´ì „ì„± ë¶„ì„
            ```
            ${{ steps.analyze.outputs.analysis_log_md || 'ë¶„ì„ ê²°ê³¼ ì—†ìŒ' }}
            ```

            ---

            #### ğŸ¯ ì‹¤í–‰ëœ í…ŒìŠ¤íŠ¸ ëª©ë¡
            ```
            ${{ steps.analyze.outputs.tests_list_md || 'ì‹¤í–‰ëœ í…ŒìŠ¤íŠ¸ ì—†ìŒ' }}
            ${{ job.status == 'failure' && '---' || '' }}
            ${{ job.status == 'failure' && 'ğŸš¨ **ë¹Œë“œê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤:** `Run Selected Tests` ë˜ëŠ” `Run All Tests (Fallback)` ë‹¨ê³„ì˜ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì—¬ ì‹¤íŒ¨í•œ í…ŒìŠ¤íŠ¸ë¥¼ ìˆ˜ì •í•˜ì„¸ìš”.' || '' }}